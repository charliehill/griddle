<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minigrid</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #FFFFFF;
        }

        header {
            height: 50px;
            padding: 8px;
        }

        spacer {
            height: 20px;
        }

        .nickname {
            width: 150px;
            height: 20px;

            padding: 5px;
            font-size: 16pt;
            border-style: solid;
            border-width: 2px 2px 2px 30px; /* top, right, bottom, left */
            border-radius: 7px;
            border-color: #ddd;
        }

        .gameboard {
            height: 400px;
            width: 400px;

            display: grid;
            grid-template-columns: auto auto auto;
            grid-gap: 8px;
            padding: 8px;
        }

        .gameboard > div {
            height: 100%;
            width: 100%;
            height: 120px;
            width: 120px;

            display: grid;
            text-align: center;
            align-items: center;

            font-size: 70px;
            background-color: #eee;
            border-radius: 7px;
        }
 
        .userColor {
            width: 400px;
            height: 40px;

            border-style: solid;
/*            border-width: 1px;
*/
            border-color: black; 
        }

        .buttonarea {
            height: 100px;
            width: 400px;

            display: grid;
            grid-template-columns: auto auto auto auto auto;
            grid-gap: 8px;
            padding: 8px;
        }

        .buttonarea > div {
            height: 100%;

            display: grid;
            text-align: center;
            align-items: center;

            font-size: 20px;
            background-color: #eee;
            border-radius: 20px;
        }
 
    </style>
</head>

<body> 
    <header>
        <form id="header" action="">
            <input id="nickname" class="nickname" autocomplete="off" oninput="genUserColor()"/>
        </form>    
    </header>
    <div class="gameboard" id="gameboard" onclick="processClick(event)">
        <div id="cell.0.0"></div>
        <div id="cell.0.1"></div>
        <div id="cell.0.2"></div>  
        <div id="cell.1.0"></div>
        <div id="cell.1.1"></div>
        <div id="cell.1.2"></div>
        <div id="cell.2.0"></div>
        <div id="cell.2.1"></div>
        <div id="cell.2.2"></div>
    </div>
    <div class="spacer"></div>
    <div class="buttonarea" id="buttonarea" onclick="processValue(event)">
        <div id="button.0">x</div>
        <div id="button.1">1</div>
        <div id="button.2">2</div>  
        <div id="button.3">3</div>
        <div id="button.4">4</div>
        <div id="button.5">5</div>
        <div id="button.6">6</div>
        <div id="button.7">7</div>
        <div id="button.8">8</div>
        <div id="button.9">9</div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const defaultColor = "#eee";
        
        // Connect to the server and get a socket by return
        var socket = io();
        
        // Function to catch a click and send it to server
        function processClick(event) { 
            event.preventDefault();
            if (event.target.id != "gameboard") { // Make sure it's in a cell and not the spacing around it
                socket.emit('cell click', {cell: event.target.id, name: nickname.value, color: color});
            } 
        }

        function processValue(event) { 
            event.preventDefault();
            if (event.target.id != "buttonarea") { // Make sure it's in a button and not the spacing around it
                socket.emit('set value', nickname.value, buttonValue(event.target.id));
            }
        }

        // Listen for incoming clicks 
        socket.on('cell update', function(click, oldCell) {
            unSetUserColor(oldCell);
            setUserColor(click.cell, click.color);
        });

        socket.on('value set', function(name, value) {
            setValue(name, value);
        });

        // Function to generate highlight color from user's nickname
        function stringToColor(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            var color = '#';
            for (var i = 0; i < 3; i++) {
                // var value = (hash >> (i * 8)) & 0xFF // Full range of values 0-256
                // var value = ((hash >> (i * 8)) & 0x88) + 0x44; // Mid range values only 64-192
                var value = ((hash >> (i * 8)) & 0x88) + 0x66; // Mid range values only 64-192
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        // Catch a key in nickname field and generate color from it
        var color;
        
        function genUserColor() { 
            event.preventDefault();
            color=stringToColor(nickname.value);
            document.getElementById("nickname").style.borderColor = color;
        }

        function unSetUserColor (cellID) {
            if (cellID != "") {
                document.getElementById(cellID).style.backgroundColor = defaultColor;
            }
        }

        // Set the color of a cell
        function setUserColor(cell, color) { 
            document.getElementById(cell).style.backgroundColor = color; 
        }

        // Set the value of a cell
        function setValue(cell, value) { 
            document.getElementById(cell).innerHTML = value; 
        }

        // Return the value represented by the button
        function buttonValue(cellID) {
            let val = cellID.split(".")[1];
            if (val == 0) val = ""; 
            return val; 
        }
        
    </script>
</body>
</html>
